<?xml version="1.0" encoding="UTF-8"?>
<definition xmlns="http://workflow.opencastproject.org">

  <id>partial-theming</id>
  <title>Run theming operations on trimmed videos</title>
  <tags/>
  <description>
     Run theming operations on trimmed videos.
  </description>
  <configuration_panel/>
  <operations>

    <!-- Apply the theme to the mediapackage -->

    <operation
      id="theme"
      exception-handler-workflow="partial-error"
      description="Apply the theme">
      <configurations>
        <configuration key="bumper-flavor">branding/bumper</configuration>
        <configuration key="bumper-tags">archive</configuration>
        <configuration key="trailer-flavor">branding/trailer</configuration>
        <configuration key="trailer-tags">archive</configuration>
        <configuration key="title-slide-flavor">branding/titleslide</configuration>
        <configuration key="title-slide-tags">archive</configuration>
        <configuration key="watermark-flavor">branding/watermark</configuration>
        <configuration key="watermark-tags">archive</configuration>
        <configuration key="watermark-layout">theme_watermark_layout</configuration>
        <configuration key="watermark-layout-variable">theme_watermark_layout_variable</configuration>
      </configurations>
    </operation>

    <!-- Inspect the media from the theme -->

    <operation
      id="inspect"
      exception-handler-workflow="partial-error"
      description="Inspecting audio and video streams">
      <configurations>
        <configuration key="overwrite">false</configuration>
        <configuration key="accept-no-media">false</configuration>
      </configurations>
    </operation>

    <operation
      id="analyze-tracks"
      exception-handler-workflow="partial-error"
      description="Analyze trimmed tracks">
      <configurations>
        <configuration key="source-flavor">*/trimmed</configuration>
      </configurations>
    </operation>

    <!-- Create a title slide video if theme has active title slide -->

    <operation
      id="image"
      if="${theme_title_slide_active} AND NOT ${theme_title_slide_uploaded} AND ${presentation_trimmed_has_video}"
      exception-handler-workflow="partial-error"
      description="Extracting title slide image from presentation track">
      <configurations>
        <configuration key="source-flavor">presentation/trimmed</configuration>
        <configuration key="target-flavor">branding/titleslide</configuration>
        <configuration key="encoding-profile">player-preview.http</configuration>
        <configuration key="time">1</configuration>
      </configurations>
    </operation>

    <operation
      id="image"
      if="${theme_title_slide_active} AND NOT ${theme_title_slide_uploaded} AND NOT ${presentation_trimmed_has_video} AND ${presenter_trimmed_has_video}"
      exception-handler-workflow="partial-error"
      description="Extracting title slide image from presenter track">
      <configurations>
        <configuration key="source-flavor">presenter/trimmed</configuration>
        <configuration key="target-flavor">branding/titleslide</configuration>
        <configuration key="encoding-profile">player-preview.http</configuration>
        <configuration key="time">1</configuration>
      </configurations>
    </operation>

    <operation
      id="cover-image"
      if="${theme_title_slide_active} AND (${presentation_trimmed_has_video} OR ${presenter_trimmed_has_video})"
      exception-handler-workflow="partial-error"
      description="Create title slide with metadata">
      <configurations>
        <configuration key="stylesheet">file://${karaf.etc}/branding/coverimage.xsl</configuration>
        <configuration key="width">1920</configuration>
        <configuration key="height">1080</configuration>
        <configuration key="posterimage-flavor">branding/titleslide</configuration>
        <configuration key="target-flavor">branding/titleslide+metadata</configuration>
     </configurations>
    </operation>

    <operation
      id="image-to-video"
      if="${theme_title_slide_active} AND (${presentation_trimmed_has_video} OR ${presenter_trimmed_has_video})"
      exception-handler-workflow="partial-error"
      description="Create video with title slide">
      <configurations>
        <configuration key="source-flavor">branding/titleslide+metadata</configuration>
        <configuration key="target-flavor">branding/titleslide+video</configuration>
        <configuration key="duration">5</configuration>
        <configuration key="profile">image-movie.work</configuration>
      </configurations>
    </operation>

    <!-- Render watermark into presenter and presentation tracks -->

    <operation
      id="composite"
      if="${theme_watermark_active} AND ${presenter_trimmed_video}"
      exception-handler-workflow="partial-error"
      description="Render watermark into presenter track">
      <configurations>
        <configuration key="source-flavor-lower">presenter/trimmed</configuration>
        <configuration key="source-flavor-upper">not/available</configuration>
        <configuration key="source-flavor-watermark">branding/watermark</configuration>
        <configuration key="encoding-profile">composite.http</configuration>
        <configuration key="target-flavor">presenter/branded</configuration>
        <configuration key="output-resolution">lower</configuration>
        <configuration key="output-background">0x000000FF</configuration>
        <configuration key="layout-single">
          {"horizontalCoverage":1.0,"anchorOffset":{"referring":{"left":1.0,"top":0.0},"reference":{"left":1.0,"top":0.0},"offset":{"x":0,"y":0}}};
          ${theme_watermark_layout_variable}
        </configuration>
      </configurations>
    </operation>

    <operation
      id="composite"
      if="${theme_watermark_active} AND ${presentation_trimmed_video}"
      exception-handler-workflow="partial-error"
      description="Render watermark into presentation track">
      <configurations>
        <configuration key="source-flavor-lower">presentation/trimmed</configuration>
        <configuration key="source-flavor-upper">not/available</configuration>
        <configuration key="source-flavor-watermark">branding/watermark</configuration>
        <configuration key="encoding-profile">composite.http</configuration>
        <configuration key="target-flavor">presentation/branded</configuration>
        <configuration key="output-resolution">lower</configuration>
        <configuration key="output-background">0x000000FF</configuration>
        <configuration key="layout-single">
          {"horizontalCoverage":1.0,"anchorOffset":{"referring":{"left":1.0,"top":0.0},"reference":{"left":1.0,"top":0.0},"offset":{"x":0,"y":0}}};
          ${theme_watermark_layout_variable}
        </configuration>
      </configurations>
    </operation>

    <operation
      id="tag"
      if="NOT ${theme_watermark_active}"
      description="Tagging presenter track as input for next operation">
      <configurations>
        <configuration key="source-flavors">presenter/trimmed</configuration>
        <configuration key="target-flavor">presenter/branded</configuration>
      </configurations>
    </operation>

    <operation
      id="tag"
      if="NOT ${theme_watermark_active}"
      description="Tagging presentation track as input for next operation">
      <configurations>
        <configuration key="source-flavors">presentation/trimmed</configuration>
        <configuration key="target-flavor">presentation/branded</configuration>
      </configurations>
    </operation>

    <!-- Add bumper and trailer part to the presenter track -->

    <operation
      id="concat"
      exception-handler-workflow="partial-error"
      description="Concatenate presenter track with intro, title slide and outro videos">
      <configurations>
        <configuration key="source-flavor-part-0">branding/bumper</configuration>
        <configuration key="source-flavor-part-0-mandatory">${theme_bumper_active}</configuration>
        <configuration key="source-flavor-part-1">branding/titleslide+video</configuration>
        <configuration key="source-flavor-part-1-mandatory">${theme_title_slide_active}</configuration>
        <configuration key="source-flavor-part-2">presenter/branded</configuration>
        <configuration key="source-flavor-part-2-mandatory">true</configuration>
        <configuration key="source-flavor-part-3">branding/trailer</configuration>
        <configuration key="source-flavor-part-3-mandatory">${theme_trailer_active}</configuration>
        <configuration key="target-flavor">presenter/themed</configuration>
        <configuration key="encoding-profile">concat.work</configuration>
        <configuration key="output-resolution">part-2</configuration>
        <configuration key="output-framerate">part-2</configuration>
      </configurations>
    </operation>

    <!-- Add bumper and trailer part to the presentation track -->

    <operation
      id="concat"
      exception-handler-workflow="partial-error"
      description="Concatenate presentation track with intro, title slide and outro videos">
      <configurations>
        <configuration key="source-flavor-part-0">branding/bumper</configuration>
        <configuration key="source-flavor-part-0-mandatory">${theme_bumper_active}</configuration>
        <configuration key="source-flavor-part-1">branding/titleslide+video</configuration>
        <configuration key="source-flavor-part-1-mandatory">${theme_title_slide_active}</configuration>
        <configuration key="source-flavor-part-2">presentation/branded</configuration>
        <configuration key="source-flavor-part-2-mandatory">true</configuration>
        <configuration key="source-flavor-part-3">branding/trailer</configuration>
        <configuration key="source-flavor-part-3-mandatory">${theme_trailer_active}</configuration>
        <configuration key="target-flavor">presentation/themed</configuration>
        <configuration key="encoding-profile">concat.work</configuration>
        <configuration key="output-resolution">part-2</configuration>
        <configuration key="output-framerate">part-2</configuration>
      </configurations>
    </operation>

  </operations>
</definition>
